# 嵌入式外设管理框架（EPMF）  
> **Embedded Peripheral Management Framework**  
> 一个高可靠、事件驱动、可配置的嵌入式设备外设统一管理中间件

---

## 目录

- [1、项目概述](#1项目概述)
- [2、架构设计](#2架构设计)
  - [2.1 分层控制架构](#21-分层控制架构)
  - [2.2 事件驱动控制策略](#22-事件驱动控制策略)
  - [2.3 工厂模式：协议帧分发器](#23-工厂模式协议帧分发器)
  - [2.4 技术亮点](#24-技术亮点)
    - [2.4.1 安全可靠的串口通信机制](#241-安全可靠的串口通信机制)
    - [2.4.2 智能外设控制系统](#242-智能外设控制系统)
    - [2.4.3 异常检测与诊断集成](#243-异常检测与诊断集成)
    - [2.4.4 线程安全的命令同步模型](#244-线程安全的命令同步模型)

---

## 1、项目概述

本项目实现了一个面向机器人/工业控制场景的**嵌入式外设管理框架**，用于统一协调底层硬件模块（如电源单元、遥控器、状态指示灯等）与上层控制系统之间的通信与状态同步。核心目标包括：

- **多设备并发通信**：支持多个串口设备并行接入与独立管理  
- **状态透明化**：实时采集关键运行参数（电量、电压、信号强度等）  
- **安全策略执行**：实现低电量保护、急停响应、异常告警等安全机制  
- **诊断系统集成**：无缝对接标准诊断消息系统，支持集中监控  
- **灵活可配置**：通过外部配置文件定义外设行为，无需修改代码  

该框架采用 **C++11 + 多线程 + 事件驱动** 架构，已在实际嵌入式产品中稳定运行。

---

## 2、架构设计

### 2.1 分层控制架构

整体采用**三层解耦设计**：

```
┌──────────────────────┐
│   应用层（ROS/诊断系统） │ ← 订阅状态 / 发送控制指令
├──────────────────────┤
│   管理层（核心逻辑）     │ ← 状态机 / 事件处理 / 策略决策
├──────────────────────┤
│   驱动层（串口/协议）    │ ← 原始数据收发 / 协议解析
└──────────────────────┘
```


- **优势**：各层职责清晰，便于测试、维护与扩展。

### 2.2 事件驱动控制策略

- **输入**：来自诊断系统的标准化事件消息（如“工作模式切换”、“组件异常”）
- **处理**：
  - 根据事件类型与级别（OK / ERROR）触发不同处理流程
  - 维护全局状态标志（如 `is_emergency_stop`, `is_low_power`）
- **输出**：
  - 自动计算最优外设状态（如灯光颜色、蜂鸣器频率）
  - 下发控制指令至对应硬件模块

> ✅ **设计亮点**：采用**优先级仲裁机制**，确保安全事件（如急停）始终优先于普通状态变更。

### 2.3 工厂模式：协议帧分发器

为支持多类型设备通信，设计了**基于命令字的帧分发工厂**：

```cpp
// 伪代码示意（无真实命令字）
int processFrame(uint8_t* data, int len) {
    CommandType cmd = parseCommand(data);
    switch (cmd) {
        case LOG_DATA:      handleLog(data);      break;
        case STATUS_UPDATE: handleStatus(data);   break;
        case COMMAND_ACK:   handleResponse(data); break;
        default:            handleUnknown();      break;
    }
}
```
- 优势：新增设备类型只需扩展 switch 分支，符合开闭原则。


### 2.4 技术亮点
#### 2.4.1 安全可靠的串口通信机制
- 协议鲁棒性：
    - 自定义二进制帧结构，含帧头校验与数据完整性验证
    - 内置状态机处理粘包、丢包、乱序问题

- 链路健壮性：
    - 串口异常时自动重连（可配置重试次数）
    - 支持心跳保活机制（可选）
#### 2.4.2 智能外设控制系统
- 策略驱动灯光管理：
    - 根据系统状态（正常/低电量/异常/急停）动态计算目标灯光效果
    - 采用防抖更新：仅当目标状态变化时才下发指令，减少通信负载

- 配置化行为定义：
    - 所有灯光模式通过 YAML 文件配置（如颜色、闪烁频率、持续时间）


#### 2.4.3 异常检测与诊断集成
- 分级告警机制：
    - 将硬件异常映射为标准诊断级别（INFO / WARNING / ERROR）
    - 支持“触发-恢复”事件精准上报，避免重复告警

- 诊断系统对接：
    - 自动将电池、电压、通信状态等发布到标准诊断话题
    - 上层监控系统可统一查看设备健康状态


#### 2.4.4 线程安全的命令同步模型

为解决“查询-响应”类操作的线程同步问题，采用生产者-消费者模型： 

```
┌─────────────┐       ┌─────────────┐
│ 主通信线程   │       │ 查询线程     │
│ (生产者)     │       │ (消费者)     │
│             │       │             │
│ 收到响应帧 → │──────▶│ 等待通知     │
│ 通知条件变量  │       │ 超时返回     │
└─────────────┘       └─────────────┘
        ▲                   ▲
        └── 共享缓冲区 ◄────┘
           (受互斥锁保护)
```

- 关键技术：
    - 使用 std::mutex + std::condition_variable 实现安全等待
    - 设置超时机制（如 3 秒），避免永久阻塞
    - 有效规避“丢失唤醒（Lost Wakeup）”等经典竞态问题

- 可扩展性设计
    - 新增外设类型：只需实现新的协议解析器并注册到工厂
    - 新增诊断项：任何模块均可通过标准接口发布状态，框架自动响应
    - 更换通信接口：驱动层抽象，未来可扩展 CAN、Ethernet 等总线